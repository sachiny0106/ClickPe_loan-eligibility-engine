{
  "active": false,
  "name": "Workflow B: User-Loan Matching",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "process-matches",
        "responseMode": "lastNode"
      },
      "id": "webhook",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT user_id, name, email, monthly_income, credit_score, employment_status, age FROM users WHERE created_at > NOW() - INTERVAL '24 hours' LIMIT 1000"
      },
      "id": "get-users",
      "name": "Stage 1: SQL Pre-Filter Users",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT product_id, product_name, interest_rate, min_income, min_credit_score, max_credit_score FROM loan_products"
      },
      "id": "get-products",
      "name": "Get Loan Products",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [450, 500]
    },
    {
      "parameters": {
        "jsCode": "/*\n * OPTIMIZATION TREASURE HUNT SOLUTION\n * =====================================\n * Multi-stage filtering pipeline to optimize matching:\n *\n * STAGE 1: SQL Pre-Filter (already done above)\n *   - Only fetch users from last 24 hours\n *   - Limit to 1000 users per batch\n *\n * STAGE 2: In-Memory Rule-Based Matching (this node)\n *   - Fast O(n*m) comparison using simple numeric rules\n *   - Eliminates 90%+ of invalid pairs instantly\n *\n * STAGE 3: LLM Enhancement (optional, for borderline cases)\n *   - Only called for users with 2+ potential matches\n *   - Uses Gemini/GPT to rank and personalize recommendations\n */\n\nconst users = $('Stage 1: SQL Pre-Filter Users').all();\nconst products = $('Get Loan Products').all();\nconst matches = [];\n\n// Stage 2: Fast rule-based matching\nfor (const userItem of users) {\n  const user = userItem.json;\n  \n  for (const productItem of products) {\n    const product = productItem.json;\n    \n    // Hard criteria checks (instant elimination)\n    const incomeOk = user.monthly_income >= product.min_income;\n    const creditOk = user.credit_score >= product.min_credit_score && \n                     user.credit_score <= product.max_credit_score;\n    \n    // Employment bonus (soft factor)\n    const employmentBonus = user.employment_status === 'Employed' ? 1 : \n                            user.employment_status === 'Self-Employed' ? 0.8 : 0.5;\n    \n    if (incomeOk && creditOk && employmentBonus >= 0.5) {\n      matches.push({\n        user_id: user.user_id,\n        product_id: product.product_id,\n        user_email: user.email,\n        user_name: user.name,\n        product_name: product.product_name,\n        interest_rate: product.interest_rate,\n        match_score: (employmentBonus * 100).toFixed(0)\n      });\n    }\n  }\n}\n\nconsole.log(`Matched ${matches.length} user-product pairs`);\nreturn matches.map(m => ({ json: m }));"
      },
      "id": "matching-logic",
      "name": "Stage 2: Rule-Based Matching",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO matches (user_id, product_id) VALUES ('{{ $json.user_id }}', {{ $json.product_id }}) ON CONFLICT (user_id, product_id) DO NOTHING"
      },
      "id": "save-matches",
      "name": "Save Matches to DB",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [850, 400]
    },
    {
      "parameters": {
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [{ "name": "key", "value": "YOUR_GEMINI_API_KEY" }]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [{
            "name": "contents",
            "value": "=[{\"parts\":[{\"text\":\"Rank these loan products for a user with income {{ $json.monthly_income }} and credit score {{ $json.credit_score }}: {{ $json.matched_products }}\"}]}]"
          }]
        }
      },
      "id": "llm-ranking",
      "name": "Stage 3: LLM Ranking (Optional)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1050, 400],
      "disabled": true
    },
    {
      "parameters": {
        "conditions": {
          "number": [{
            "value1": "={{ $json.length }}",
            "operation": "larger",
            "value2": 0
          }]
        }
      },
      "id": "check-matches",
      "name": "Has Matches?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "url": "https://kaleb-tumefacient-ceaselessly.ngrok-free.dev/webhook/send-notifications",
        "method": "POST",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [{ "name": "status", "value": "matches_complete" }]
        }
      },
      "id": "trigger-notifications",
      "name": "Trigger Notification Workflow",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1250, 300]
    }
  ],
  "connections": {
    "Webhook Trigger": {
      "main": [[
        { "node": "Stage 1: SQL Pre-Filter Users", "type": "main", "index": 0 },
        { "node": "Get Loan Products", "type": "main", "index": 0 }
      ]]
    },
    "Stage 1: SQL Pre-Filter Users": {
      "main": [[{ "node": "Stage 2: Rule-Based Matching", "type": "main", "index": 0 }]]
    },
    "Get Loan Products": {
      "main": [[{ "node": "Stage 2: Rule-Based Matching", "type": "main", "index": 0 }]]
    },
    "Stage 2: Rule-Based Matching": {
      "main": [[{ "node": "Save Matches to DB", "type": "main", "index": 0 }]]
    },
    "Save Matches to DB": {
      "main": [[{ "node": "Has Matches?", "type": "main", "index": 0 }]]
    },
    "Has Matches?": {
      "main": [
        [{ "node": "Trigger Notification Workflow", "type": "main", "index": 0 }],
        []
      ]
    }
  }
}
